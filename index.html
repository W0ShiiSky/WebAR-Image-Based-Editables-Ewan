<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/gh/mathusummut/confetti.js/confetti.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./static/css/style.css" />
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  </head>
  <body style="margin: 0; background-color: black;">
    <!-- id="UI-overlay" fixes the issue where the AR content gets cutoff at where the buttons are -->
    <!-- display flex is to prevent the UI overlay from disappearing when displaying AR content. Can be removed -->
    <div id="UI-overlay" style="max-height: 100%; max-width: 100%;">
      <div id="UI-placement">
        <!-- scanning box crosshair copied from MindAR example -->
        <div id="scanning-overlay" class="mindar-ui-scanning">
          <div class="scanning">
            <div class="inner" id="scanBoxSize">
              <div class="scanline"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="fortune-cookie" id="fortuneCookie" style="display: none;">
      <div class="cookie-left" id="cookieLeft"></div>
      <div class="cookie-right" id="cookieRight"></div>
    </div>
    <div class="fortune-slip" id="fortuneSlip"></div>

    <a-scene mindar-image="imageTargetSrc: ./static/mind-file/Shinchan.mind; uiScanning: #scanning-overlay; filterMinCF:0.0001; filterBeta: 0.001;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" embedded>
      <a-entity id="example-target" mindar-image-target="targetIndex: 0">  
        <a-gltf-model id="model" rotation="0 0 0 " position="0 -3 -9" scale="2 2 2" animation-mixer></a-gltf-model>
      </a-entity>
      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: ${customFields.libVersion}; objects: .clickable"></a-camera>
    </a-scene>

    <script>
      // Define handleInteraction function before attaching event listeners
      function handleInteraction() {
        if (hasClicked) return; // If already clicked, do nothing
        hasClicked = true; // Set flag to true after the first click

        // Display the fortune slip and crack the fortune cookie
        const fortuneSlip = document.getElementById('fortuneSlip');
        const randomFortune = fortunes[Math.floor(Math.random() * fortunes.length)];
        fortuneSlip.textContent = randomFortune;

        // Set timeout to add 'cracked' class after 1 second
        setTimeout(() => {
          fortuneCookie.classList.remove('shaking'); // Remove the shaking class
          fortuneCookie.classList.add('cracked');

          // Trigger confetti effect
          fire(0.25, {
            spread: 50,
            startVelocity: 55,
          });

          fire(0.2, {
            spread: 100,
          });

          fire(0.35, {
            spread: 150,
            decay: 0.91,
            scalar: 0.8,
          });

          fire(0.1, {
            spread: 150,
            startVelocity: 25,
            decay: 0.92,
            scalar: 1.2,
          });

          fire(0.1, {
            spread: 140,
            startVelocity: 45,
          });

        }, 1000);
        const uiOverlay = document.getElementById('UI-overlay');
        uiOverlay.style.display = 'none';
      }

      // Inside the DOMContentLoaded event listener, attach event listeners to the scene
      document.addEventListener("DOMContentLoaded", function () {
        const exampleTarget = document.querySelector("#example-target");
        const fortunes = [
          // Array of fortunes...
        ];
        
        // Hide the fortune cookie initially
        const fortuneCookie = document.getElementById('fortuneCookie');
        fortuneCookie.style.display = "none";
        fortuneCookie.classList.add('shaking'); // Add the shaking class

        // Listen for the target found event
        exampleTarget.addEventListener("targetFound", event => {
          console.log("Target detected:");
          console.log("Loading random model...");
          
          // Show the fortune cookie after the target is found
          fortuneCookie.style.display = "block";
        });
        
        // Function for confetti
        const count = 200;
        const defaults = { origin: { y: 0.7 } };

        function fire(particleRatio, opts) {
          const spread = Math.random() * 360;
          const startVelocity = Math.random() * 100;
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio),
            spread: spread,
            startVelocity: startVelocity,
          }));
        }
        
        let hasClicked = false;

        // Listen for both click and touchstart events on the scene
        document.querySelector("a-scene").addEventListener("click", handleInteraction);
        document.querySelector("a-scene").addEventListener("touchstart", handleInteraction);
      });
    </script>
  </body>
</html>