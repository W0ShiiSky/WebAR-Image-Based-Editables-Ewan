<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./static/css/style.css" />
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  </head>
  <body style="margin: 0; background-color: black;">
    <div id="UI-overlay" style="max-height: 100%; max-width: 100%;">
      <div id="UI-placement">
        <div id="scanning-overlay" class="mindar-ui-scanning">
          <div class="scanning">
            <div class="inner" id="scanBoxSize">
              <div class="scanline"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./static/mind-file/Shinchan.mind; uiScanning: #scanning-overlay; filterMinCF:0.0001; filterBeta: 0.001;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" embedded>
      <a-assets>
        <a-asset-item id="minecraft_chest" src="./static/3D-file/glb/minecraft_chest_without_animation.glb"></a-asset-item>
        <a-asset-item id="minecraft_chest_animate" src="./static/3D-file/glb/untitled6.glb"></a-asset-item>
      </a-assets>

      <a-entity id="example-target" mindar-image-target="targetIndex: 0">  
        <a-gltf-model id="minecraft_chest_model" src="#minecraft_chest" rotation="90 -90 0" position="-0.4 0 0" scale="0.005 0.005 0.005" animation-mixer visible="true"></a-gltf-model>
        <a-gltf-model id="minecraft_chest_model_animate" src="#minecraft_chest_animate" rotation="0 -90 0" position="0 0 0" scale="0.005 0.005 0.005" animation-mixer="clip: ./static/3D-file/glb/untitled6.glb; loop: once" visible="false"></a-gltf-model>
      </a-entity>

      <div class="fortune-slip" id="fortuneSlip"></div>

      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: ${customFields.libVersion}; objects: .clickable"></a-camera>
    </a-scene>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const exampleTarget = document.querySelector("#example-target");
        const fortunes = [
          "Success is on your horizon.",
          "Good news will come to you by mail.",
          "A pleasant surprise is waiting for you.",
          "You will meet someone special soon.",
          "Your hard work will pay off.",
          "Adventure is in your future.",
          "Happiness will come your way soon.",
          "A lifetime of happiness lies ahead of you.",
          "You will soon find the love of your life.",
          "Financial prosperity is coming your way.",
          "A new opportunity will present itself to you.",
          "Your creative talents will be recognized and rewarded.",
          "You will make lasting memories with friends and family.",
          "Travel plans will bring you joy and excitement.",
          "Unexpected blessings are coming your way.",
          "You will overcome obstacles with ease.",
          "An exciting adventure awaits you.",
          "Your kindness will be repaid in unexpected ways.",
          "You will achieve your goals with determination and perseverance.",
          "A windfall of good fortune is heading your way."
        ];
        
        // Hide the fortune cookie initially
        const minecraftChest = document.getElementById("minecraft_chest_model");
        const minecraftChestAnimate = document.getElementById("minecraft_chest_model_animate");
        minecraftChestAnimate.style.display = "none";
        minecraftChest.classList.add("shaking"); // Add the shaking class
        minecraftChestAnimate.setAttribute("visible", "false");

        // Listen for the target found event
        exampleTarget.addEventListener("targetFound", event => {
          console.log("Target detected:");
          console.log("Loading random model...");
          
          // Show the fortune cookie after the target is found
          minecraftChest.style.display = "block";
        });
        
        // Function for confetti
        const count = 200;
        const defaults = { origin: { y: 0.7 } };

        function fire(particleRatio, opts) {
          const spread = Math.random() * 360; // Random spread angle between 0 and 360
          const startVelocity = Math.random() * 100; // Random start velocity between 0 and 100
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio),
            spread: spread,
            startVelocity: startVelocity,
          }));
        }
        
        let hasClicked = false; // Flag to prevent multiple clicks

        // Function to handle interaction (click or touch)
        function handleInteraction(){
          if (hasClicked) return; // If already clicked, do nothing
          hasClicked = true; // Set flag to true after the first click

          // Display the fortune slip and crack the fortune cookie
          const fortuneSlip = document.getElementById("fortuneSlip");
          const randomFortune = fortunes[Math.floor(Math.random() * fortunes.length)];
          fortuneSlip.textContent = randomFortune;
          console.log(randomFortune);

          // Set timeout to add 'cracked' class after 1 second
          setTimeout(() => {
            minecraftChest.classList.remove("shaking");
            minecraftChest.setAttribute("visible", "false");
            minecraftChestAnimate.setAttribute("visible", "true");
            minecraftChestAnimate.style.display = "block"; // Ensure it's visible

            // Trigger confetti effect
            fire(0.25, {
              spread: 50,
              startVelocity: 55,
            });

            fire(0.2, {
              spread: 100,
            });

            fire(0.35, {
              spread: 150,
              decay: 0.91,
              scalar: 0.8,
            });

            fire(0.1, {
              spread: 150,
              startVelocity: 25,
              decay: 0.92,
              scalar: 1.2,
            });

            fire(0.1, {
              spread: 140,
              startVelocity: 45,
            });

          }, 1000);
          const uiOverlay = document.getElementById('UI-overlay');
          uiOverlay.style.display = 'none';
        }

        document.querySelector("a-scene").addEventListener("click", handleInteraction);
        document.querySelector("a-scene").addEventListener("touchstart", handleInteraction);
      });
    </script>
  </body>
</html>