<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0">
  <title>AR Fortune</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./static/css/style.css">
  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
</head>
<body style="margin: 0; background-color: black;">
  <div id="UI-overlay" style="max-height: 100%; max-width: 100%;">
    <div id="UI-placement">
      <div id="scanning-overlay" class="mindar-ui-scanning">
        <div class="scanning">
          <div class="inner" id="scanBoxSize">
            <div class="scanline"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="fortuneSlip" class="fortune-slip"></div>
  <a-scene id="ar-scene" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" embedded>
    <a-assets>
      <a-asset-item id="minecraft_chest"></a-asset-item>
      <a-asset-item id="minecraft_chest_animate" src="./static/3D-file/glb/untitled10.glb"></a-asset-item>
    </a-assets>

    <a-entity id="example-target" mindar-image-target="targetIndex: 0">
      <a-gltf-model id="minecraft_chest_model" src="#minecraft_chest" rotation="90 -90 0" position="-0.4 0 0" scale="0.005 0.005 0.005" animation-mixer visible="true"></a-gltf-model>
      <a-gltf-model id="minecraft_chest_model_animate" src="#minecraft_chest_animate" rotation="0 -90 0" position="0 0 0" scale="0.005 0.005 0.005" animation-mixer="loop: once; clip: *; timeScale: 0" visible="false"></a-gltf-model>
    </a-entity>

    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: ${customFields.libVersion}; objects: .clickable"></a-camera>
  </a-scene>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      Promise.all([
        fetch('./static/data/fortunes.json').then(response => response.json()),
        fetch('./static/data/config.json').then(response => response.json()),
        fetch('./static/data/model_config.json').then(response => response.json())
      ])
      .then(([fortunesData, configData, modelConfigData]) => {
        console.log("Fortunes Data:", fortunesData);
        console.log("Config Data:", configData);
        console.log("Model Config Data:", modelConfigData);
        const fortunes = fortunesData.fortunes;
        initializeAR(fortunes, configData, modelConfigData);
      })
      .catch(error => console.error('Error loading data:', error));
    });

    function initializeAR(fortunes, config, modelConfig) {
      const arScene = document.getElementById('ar-scene');
      const exampleTarget = document.querySelector("#example-target");

      // Apply configuration to the mindar-image component
      arScene.setAttribute('mindar-image', {
        imageTargetSrc: config.imageTargetSrc,
        uiScanning: config.uiScanning,
        filterMinCF: config.filterMinCF,
        filterBeta: config.filterBeta
      });

      const minecraftChest = document.getElementById("minecraft_chest_model");
      const minecraftChestAnimate = document.getElementById("minecraft_chest_model_animate");
      const fortuneSlip = document.getElementById("fortuneSlip");
      minecraftChestAnimate.style.display = "none";
      minecraftChest.classList.add("shaking");
      minecraftChestAnimate.setAttribute("visible", "false");

      let isTargetFound = false;

      exampleTarget.addEventListener("targetFound", event => {
        console.log("Target detected:");
        minecraftChest.style.display = "block";
        isTargetFound = true;

        // Show fortune slip when target is found
        fortuneSlip.style.transform = "translate(-50%, -50%) scale(1)";
        fortuneSlip.style.opacity = "1";
      });

      exampleTarget.addEventListener("targetLost", event => {
        console.log("Target lost:");
        isTargetFound = false;

        // Hide fortune slip when target is lost
        fortuneSlip.style.transform = "translate(-50%, -50%) scale(0)";
        fortuneSlip.style.opacity = "0";
      });

      // Dynamically adjust the position and rotation of the 3D model based on the target image's orientation
      exampleTarget.addEventListener("mindar-image-update", event => {
        if (!isTargetFound) return;

        const { position, rotation } = event.detail;

        // Adjust the position of the 3D model
        minecraftChest.object3D.position.copy(position);
        minecraftChestAnimate.object3D.position.copy(position);

        // Adjust the rotation of the 3D model
        minecraftChest.object3D.rotation.copy(rotation);
        minecraftChestAnimate.object3D.rotation.copy(rotation);
      });

      const count = 200;
      const defaults = { origin: { y: 0.7 } };

      function fire(particleRatio, opts) {
        const spread = Math.random() * 360;
        const startVelocity = Math.random() * 100;
        confetti(Object.assign({}, defaults, opts, {
          particleCount: Math.floor(count * particleRatio),
          spread: spread,
          startVelocity: startVelocity,
        }));
      }

      let hasClicked = false;
      let hasOpened = false;

      function handleInteraction(){
        if (!isTargetFound) return;
        if (hasClicked) return;
        hasClicked = true;
        if (hasOpened) return;
        hasOpened = true;

        const randomFortune = fortunes[Math.floor(Math.random() * fortunes.length)];
        fortuneSlip.textContent = randomFortune;
        fortuneSlip.style.display = "block"; // Make fortune slip visible
        console.log(randomFortune);

        minecraftChest.setAttribute("visible", "false");
        minecraftChestAnimate.setAttribute("visible", "true");
        minecraftChestAnimate.style.display = "block";
        minecraftChestAnimate.setAttribute('animation-mixer', 'timeScale: 0.5');

        fire(0.25, {
          spread: 50,
          startVelocity: 55,
        });

        fire(0.2, {
          spread: 100,
        });

        fire(0.35, {
          spread: 150,
          decay: 0.91,
          scalar: 0.8,
        });

        fire(0.1, {
          spread: 150,
          startVelocity: 25,
          decay: 0.92,
          scalar: 1.2,
        });

        fire(0.1, {
          spread: 140,
          startVelocity: 45,
        });

        const uiOverlay = document.getElementById('UI-overlay');
        uiOverlay.style.display = 'none';
      }

      document.querySelector("a-scene").addEventListener("click", handleInteraction);
      document.querySelector("a-scene").addEventListener("touchstart", handleInteraction);
    }
  </script>
</body>
</html>
